#Ubuntu 24 OS裝好
#網路設好
sudo apt install network-manager
sudo reboot
如果有用 nmcli設網路要確認會不會跑掉


hostnamectl     # check the Ubuntu version 


 $$$$錢字號這些不用做只是參考
$ sudo lshw -numeric -C display
$ sudo apt-get purge nvidia*
$ sudo add-apt-repository ppa:graphics-drivers
$ sudo apt-get update
$ sudo apt upgrade
$ ubuntu-drivers list
$ sudo apt install nvidia-driver-545
$ reboot



sudo lshw -numeric -C display
sudo apt install nvidia-driver-580		#nvidia driver 先裝好 
sudo reboot


sudo apt install nvidia-utils-565-server             #應該是對映符合的版本都可
nvidia-smi


# 1. 更新 apt 包索引並安裝依賴
sudo apt update
sudo apt install ca-certificates curl gnupg

# 2. 添加 Docker 的官方 GPG 金鑰
sudo install -m 0755 -d /etc/apt/keyrings
curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
sudo chmod a+r /etc/apt/keyrings/docker.gpg

# 3. 添加 Docker 倉庫到 Apt source
echo \
  "deb [arch=\"$(dpkg --print-architecture)\" signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
  \"$(. /etc/os-release && echo \"$VERSION_CODENAME\")\" stable" | \
  sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

# 4. 再次更新 apt 包索引
sudo apt update

# 5. 安裝 Docker Engine、CLI 和 Containerd
sudo apt install docker-ce docker-ce-cli containerd.io docker-buildx-plugin docker-compose-plugin

# 6. (可選) 將當前用戶添加到 docker 組，以便無需 sudo 運行 docker 命令
sudo usermod -aG docker $USER

# 7. 重新登錄或運行 newgrp docker 命令使分組生效
# （建議直接重啟終端或重新登錄）



安裝 NVIDIA Container Toolkit (如果您有 NVIDIA GPU)
如果您有 NVIDIA GPU 並希望利用它進行加速，請安裝 nvidia-container-toolkit


https://docs.nvidia.com/datacenter/cloud-native/container-toolkit/latest/install-guide.html

sudo apt-get update && sudo apt-get install -y --no-install-recommends \
   curl \
   gnupg2


# 1. 添加 NVIDIA 倉庫

curl -fsSL https://nvidia.github.io/libnvidia-container/gpgkey | sudo gpg --dearmor -o /usr/share/keyrings/nvidia-container-toolkit-keyring.gpg \
  && curl -s -L https://nvidia.github.io/libnvidia-container/stable/deb/nvidia-container-toolkit.list | \
    sed 's#deb https://#deb [signed-by=/usr/share/keyrings/nvidia-container-toolkit-keyring.gpg] https://#g' | \
    sudo tee /etc/apt/sources.list.d/nvidia-container-toolkit.list

sudo sed -i -e '/experimental/ s/^#//g' /etc/apt/sources.list.d/nvidia-container-toolkit.list

# 2. 更新並安裝
sudo apt-get update
export NVIDIA_CONTAINER_TOOLKIT_VERSION=1.18.0-1
  sudo apt-get install -y \
      nvidia-container-toolkit=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
      nvidia-container-toolkit-base=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
      libnvidia-container-tools=${NVIDIA_CONTAINER_TOOLKIT_VERSION} \
      libnvidia-container1=${NVIDIA_CONTAINER_TOOLKIT_VERSION}


# 3. 配置 Docker 使用 NVIDIA 運行時並重啟 Docker 服務
sudo nvidia-ctk runtime configure --runtime=docker
sudo systemctl restart docker



docker-compose.yaml
user@node4:~/oo$ cat docker-compose.yaml
version: '3.8'

services:
  ollama:
    image: ollama/ollama
    container_name: ollama
    restart: always
    network_mode: "host"          # ★ 主機網路模式：外部可直接存取
    volumes:
      - ./ollama/data:/root/.ollama
# ✨ NVIDIA GPU 配置
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

    environment:
      - OLLAMA_HOST=0.0.0.0:11434  # ★ 讓所有人都能連到 Ollama

  open-webui:
    image: ghcr.io/open-webui/open-webui:main
    container_name: open-webui
    restart: always
    ports:
      - "3000:8080"

    network_mode: "host"          # ★ 主機網路模式：自動連 localhost
    volumes:
      - ./open-webui/data:/app/backend/data
    depends_on:
      - ollama
    environment:
      - OLLAMA_API_BASE_URL=http://localhost:11434/api   # ★ 永遠可連成功
####

sudo docker compose up -d



user@node4:~/oo$ docker ps
CONTAINER ID   IMAGE                                COMMAND               CREATED         STATUS                     PORTS     NAMES
21e7a7532837   ghcr.io/open-webui/open-webui:main   "bash start.sh"       3 minutes ago   Up 2 minutes (unhealthy)             open-webui
303c646569ac   ollama/ollama                        "/bin/ollama serve"   3 minutes ago   Up 2 minutes                         ollama
user@node4:~/oo$


http://192.168.55.180:8080/


OpenWebUI > Setting > admin panel  > Setting   > connections >  
Ollama API

Manage Ollama API Connections     

改成
http://localhost:11434


